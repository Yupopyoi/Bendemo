# シリアル通信フォーマット

## 概要

データはバイナリに変換してから送信する。  
その際には、COBS（Consistent Overhead Byte Stuffing）を用いてエンコード・デコードする。

## Qt側インターフェース

SerialInterfaceクラスにて扱う。

### Public Methods

- explicit SerialInterface(int tx_payload_len, int rx_payload_len);
  - コンストラクタ
  - 送信するbyte配列の長さと、受信するbyte配列の長さを引数として受け取り、設定する。

- QString port();
  - 有効なポートのうち、**一番最初のポート名**を返す。

- bool open(const QString& port_name, int baud_rate);
  - 指定したポート名とボーレートで、シリアル通信を開始する。
  - 成功すればtrueを返す。

- void close();
  - シリアル通信を終了する。
  - この関数はデストラクタ内で自動的に呼ばれる。

- bool isOpen() const;
  - シリアル通信が開始されているかを返す。

- bool SetMessage(int position, const QByteArray& chunk);
  - 書き込み開始位置と書き込む内容を受け取り、送信予定メッセージを更新する。
  - この段階では実際の送信は行わない。
  - 成功すればtrueを返す。

- bool Send();
  - 最新のメッセージを送信する。
  - 成功すればtrueを返す。

- QByteArray read() const;
  - 最新の受信メッセージを返す。

### データフォーマット (Qt -> Arduino)

合計30バイト分のデータを一度に送信できる。  

| Byte  | Bit |          Content          |
|:-----:|:---:|:-------------------------:|
|  0-1  | 0-7 |    Servo Outer Upper *1   |
|  2-3  | 0-7 |    Servo Outer Lower *1   |
|  4-5  | 0-7 |    Servo Inner Lower *1   |
|  6-7  | 0-7 |    Servo Inner Upper *1   |
|  8-9  | 0-7 |       Push Length *2      |
| 10-29 | 0-7 |         Undefined         |

*1 : 角度[deg]の10倍の値を送信すること。例えば、120度にしたいならば、1200（0x04,0xB0）を送信する。  
*2 : 長さ[mm]の10倍の値を送信すること。例えば、120mmにしたいならば、1200（0x04,0xB0）を送信する。
